---
title: "Roatan Fisheries Summary"
output: 
  html_document:
    toc: true
    toc_depth: 3 
    theme: united
date: "`r Sys.Date()`"
---

```{r global-options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.width=12, 
  fig.height = 7
)
```

This report contains a descriptive analysis of fisheries in Roatan, based on the sampled, time-series database of fish landings collected by CORAL and its partners. 

```{r setup, include=TRUE, echo=FALSE}
# Project home directory (to make sure filepaths work)
phome <- '/Users/saeesh/itme/school/IMBRSea/Academic/Thesis/fisheries-analysis'

# ==== Libraries ====
library(dplyr)
library(readr)
library(lubridate)
library(ggplot2)
library(stringr)
library(anomalize)
library(vegan)
library(patchwork)
source(file.path(phome, 'scripts/02_eda/02_selected_eda/_eda_help_funcs.R'))

# ==== Paths ====

# Path to TS dataset
ts_path <- file.path(phome, 'data/dbase_bica_clean.csv')

# Path to output directory where plots will be saved if exporting
out_dir <- file.path(phome, 'output/eda/roatan')
dir.create(out_dir)

# ==== Global/helper variables ====

# Index of essential columns (useful for viewing subsets of tables)
idx <- c('id', 'codigo', 'fecha', 'comunidad', 'zona_pesca', 'nombre_comun',
         'nombre_cientifico', 'peso', 'longitud', 'horas_pesca','tipo_arte')

# ==== Reading data ====
dat <- read_csv(ts_path)
```

## Date Preparation
```{r dprep-general, include=TRUE, echo=TRUE}
# ==== Data preparation ====

# Preparing columns
dat <- dat |> 
  # Filtering data for only Roatan
  filter(zona == 'Roatan') |> 
  # Using the cleaned common names as default
  mutate(nc_og = nombre_comun) |> 
  mutate(nombre_comun = str_to_title(nombre_comun_cln)) |> 
  # Adding "sp" to columns where the genus is present but no species is present
  mutate(species = if_else((is.na(species) & !is.na(genus)), 'sp', species)) |> 
  tidyr::unite(nombre_cientifico, genus, species, sep=' ', remove=F, na.rm=T) |> 
  # Factorizing relevant columns
  mutate(comunidad = as.factor(comunidad)) |> 
  mutate(zona_pesca = as.factor(zona_pesca)) |> 
  # Getting year, month, and year-month columns
  mutate(year = year(fecha), month=month(fecha), .after='fecha') |> 
  mutate(ym = paste(year, str_pad(month, 2, 'left', '0'), sep='-'), .after=month) |> 
  mutate(month = month.abb[month]) |> 
  # Factorizing year and month column
  mutate(year = as.factor(year)) |> 
  mutate(month = factor(month, levels=month.abb)) |> 
  # Converting weight to kg
  mutate(peso = peso/1000)

# Removing rows where no date is given
dat <- dat |> filter(!is.na(fecha))

# Removing outliers (detected based on IQR ranges specific to each
# genus/family) - based on weight
dat <- dat |> 
  # A helper grouping variable that uses the family name if the scientific name
  # is not available
  mutate(taxa = if_else(is.na(nombre_cientifico), family, nombre_cientifico)) |> 
  group_by(taxa) |> 
  # Naming outliers for each taxa group
  mutate(isoutlier = ifelse(all(is.na(peso)), 'No', anomalize::iqr(peso))) |>
  ungroup()

# Separating those that are outliers for manual inspection - they don't look
# unreasonable, so not removing anything
outliers <- dat |> filter(isoutlier == "Yes")

# Cleaing outliers
dat <- dat |> 
  # Removing unreasonable weight rows
  filter(peso < 34) |> 
  # filter(isoutlier == "No") |> 
  # Removing outlier related fields
  select(-isoutlier, -taxa)
```

# General characteristics

## 1. Most-caught fish species

```{r dprep-top10, include=TRUE}
# Creating the dataframe containing data only for the 10-most caught species (by
# number caught)
top10 <- dat |> 
  group_by(nombre_cientifico) |> 
  summarize(
    'nombre_comun' = names(tail(sort(table(nombre_comun)), 1)),
    'num_indiv' = sum(!is.na(peso)),
    'total_weight_kg' = sum(peso, na.rm=T),
    'mean_weight_kg' = mean(peso, na.rm=T),
    'sd_weight_kg' = sd(peso, na.rm=T),
    'mean_length_cm' = mean(longitud, na.rm=T),
    'sd_length_cm' = sd(longitud, na.rm=T),
    'n_length' = sum(!is.na(longitud))
  ) |> 
  mutate(se_weight = sd_weight_kg/num_indiv) |> 
  mutate(se_length = sd_length_cm/n_length) |> 
  arrange(desc(num_indiv)) |> 
  head(10)

# Index vector containing the names of the top-10 species
top10_idx <- top10$nombre_comun

# Cleaning common names for easier plot printing
top10 <- top10 |> 
  mutate(nombre_comun = str_wrap(nombre_comun, width=10, whitespace_only = T))
```
### 10 most-caught species by number and weight
```{r genr-top10-species}
# 10-most frequent: Number of caught individuals
num <- top10 |> 
  ggplot(aes(x = nombre_comun, y=num_indiv, fill=nombre_comun)) +
  geom_col(colour='black', linewidth=0.4, show.legend = F, alpha=0.9) +
  qtheme() +
  labs(
    title = 'Número de individuos',
    x = NULL,
    y = 'Individuos'
  )

# Total caught weight
wt <- top10 |> 
  ggplot(aes(x = nombre_comun, y=total_weight_kg, fill=nombre_comun)) +
  geom_col(colour='black', linewidth=0.4, show.legend = F, alpha=0.9) +
  # scale_fill_brewer(palette = 'RdPu') +
  qtheme() +
  labs(
    title = 'Peso total',
    x = NULL,
    y = 'Peso [kg]'
  )

(num/wt)
```
## 2. Most-used gears
```{r genr-top-gears}
dat |> 
  ggplot(aes(x = tipo_arte, fill=tipo_arte)) +
  geom_bar(colour = 'black', alpha=0.9, linewidth=0.4, show.legend = F) +
  qtheme() +
  labs(
    x = NULL,
    y = 'Número de muestras'
  )
```

## 3. Catch-seasonality
```{r genr-catch-ssn}
# Functtion to create the seasonality plot
ssn_plot <- function(df){
  df |> 
    ggplot(aes(x = month)) +
    geom_bar(stat='count', 
             fill='coral3',
             alpha=0.8,
             colour='black', 
             show.legend=F) +
    qtheme() +
    labs(
      x = NULL,
      y = 'Número de individuos'
    )
}
```

### Overall Catch-seasonality
```{r genr-catch-ssn-overall}
dat |> ssn_plot()
```

### Catch-seasonality split by fishing gear
```{r genr-catch-ssn-gear}
dat |> ssn_plot() + facet_wrap('tipo_arte', scales='free_y')
```

## 4. Shannon-Diversity of caught species and gear by community

```{r genr-diversity}
# Diversity of caught species by community ----------

# Generating count matrix
dmx <- as.matrix(table(dat$comunidad, dat$nombre_comun))
# Calculating the diversity index
div_comun <- as.table(diversity(dmx, index = "shannon", MARGIN = 1, base = exp(1)))
print("Diversided de especias capturadas por comunidad:")
print(div_comun)
      
# Diversity of caught species by gear type ----------
dmx <- as.matrix(table(dat$tipo_arte, dat$nombre_comun))
div_arte <- as.table(diversity(dmx, index = "shannon", MARGIN = 1, base = exp(1)))
print("Diversidad de especias capturadas por tipo de arte:")
print(div_arte)

# Diversity of gear types by community ----------
dmx <- as.matrix(table(dat$comunidad, dat$tipo_arte))
div_arte_por_comun <- as.table(diversity(dmx, index = "shannon", MARGIN = 1, base = exp(1)))
print("Diversidad de tipos de artes por comunidad:")
print(div_arte_por_comun) 
```

## 6. Time-series trends (overall)
```{r genr-ts-dprep}
# Preparing a summarized database for time-series trend plotting (overall)
ts_df <- dat |> 
  # Calculating average CPUE per date/trip 
  group_by(fecha) |> 
  summarize(
    len_avg = mean(longitud, na.rm=T),
    wt_avg = mean(peso, na.rm=T),
    eff_avg = mean(horas_pesca, na.rm=T),
    cpue_avg = mean(peso/horas_pesca, na.rm=T),
  ) |> 
  # Removing outliers
  filter(iqr(cpue_avg) == 'No', 
         iqr(eff_avg) == 'No',
         iqr(wt_avg) == 'No') |>  
  ungroup()

# Helper function to quickly make a ts plot
make_ts <- function(df, var, label){
  ts_df |> 
  ggplot(aes(x = fecha, y = !!sym(var))) +
  geom_smooth(method='lm', colour='firebrick', alpha=0.6) +
  geom_point(alpha = 0.8) +
  qtheme() +
  labs(
    x = NULL, 
    y=label
  )
}
```

### Captured length (overall)
```{r genr-ts-length}
make_ts(ts_df, 'len_avg', 'Longitud [cm]')
```

### Captured weight (overall)
```{r genr-ts-weight}
make_ts(ts_df, 'wt_avg', 'Peso [kg]')
```

### Fishing effort (overall)
```{r genr-ts-effort}
make_ts(ts_df, 'eff_avg', 'Esfuerza de pesca [horas]')
```


### CPUE (overall)
```{r genr-ts-cpue}
make_ts(ts_df, 'cpue_avg', 'Capturas por unidad de esfuerza [kg/hora]')
```

# 10-most caught species characteristics

## 1. Catch-seasonality (10-most caught species)
```{r t10-catch-ssn, fig.height=7}
dat |> 
  filter(nombre_comun %in% top10_idx) |> 
  ssn_plot() + 
  facet_wrap('nombre_comun', scales='free_y', ncol=2)
```

## 2. Proportion of catches that are mature
```{r t10-maturity-dprep}
# Calculating asymptotic length, length at first-maturity, and optimum length
# using the equations Froese and Binohlan (2000). 
optimal_lengths <- dat |> 
  filter(nombre_comun %in% top10_idx) |> 
  group_by(nombre_comun) |> 
  # Removing outliers before detecting optimal ranges
  filter(iqr(longitud) == 'No') |> 
  summarize(
    freq = sum(!is.na(longitud)), 
    mean = mean(longitud, na.rm = T), 
    std = sd(longitud, na.rm = T), 
    se = (std/freq),
    # Equations from Froese and Binohlan (2000)
    Linf = 10^(0.044 + 0.9841*log10(max(longitud, na.rm = T))), 
    Lmat = 10^(0.8979*log10(Linf)-0.0782),
    Lopt = 10^(1.0421*log10(Linf)-0.2742)
  )

# Calculating the same but split by gears instead of years
# opt_lengths_by_year <- dat |> 
#   filter(nombre_cientifico %in% top10_idx) |> 
#   group_by(nombre_comun, year) |> 
#   mutate(isOutlier = ifelse(all(is.na(longitud)), 'No', iqr(longitud))) |> 
#   filter(isOutlier == 'No') |> 
#   summarize(
#     freq = n(), 
#     mean = mean(longitud, na.rm = T), 
#     std = sd(longitud, na.rm = T), 
#     se = (std/freq),
#     # Equations from Froese and Binohlan (2000)
#     Linf = 10^( 0.044 + 0.9841*log10(max(longitud, na.rm = T))), 
#     Lmat = 10^(0.8979*log10(Linf)-0.0782),
#     Lopt = 10^(1.0421*log10(Linf)-0.2742)
#   )
```

### Proportion of mature catches by year
```{r t10-maturity-year,  fig.height=7}
# Comparing average lengths for the top-10 species by year to the calculated
# optimal lengths for each species
dat |> 
  filter(nombre_comun %in% top10_idx) |>
  # Adding calculated length metrics for each species to the table
  left_join(optimal_lengths, by='nombre_comun') |> 
  # Calculating the percent that were mature, per year
  mutate(mature = longitud > Lmat) |> 
  group_by(nombre_comun) |> 
  summarize(
    num_mature = sum(mature, na.rm = T),
    n = sum(!is.na(longitud)),
    perc_mature = (num_mature/n)*100
  ) |> 
  # Calculating a binary column if the percentage of maturity was higher than
  # 90% (the optimal condition)
  mutate(value = if_else(perc_mature>90, "Pos", "Neg")) |> 
  # mutate(year = str_remove_all(as.character(year), '^20')) |>
  # Plotting
  ggplot(aes(x=nombre_comun, y=perc_mature, fill=value, group=nombre_comun)) +  
  geom_hline(yintercept = 90, linetype='dashed', colour='black') +
  geom_point(shape = 23, size = 2, show.legend = F) +
  scale_fill_manual(values = c("firebrick", "forestgreen"))+ 
  # facet_wrap('nombre_comun', ncol = 2) +
  qtheme() +
  labs(
    x = NULL, 
    y = "Porcentaje de capturas de individuos maduros")

```

### Proportion of mature catches by gear
```{r t10-maturity-gear, fig.height=7}
# Comparing average lengths for the top-10 species by year to the calculated
# optimal lengths for each species
dat |> 
  filter(nombre_comun %in% top10_idx) |>
  # Adding calculated length metrics for each species to the table
  left_join(optimal_lengths, by='nombre_comun') |> 
  # Calculating the percent that were mature, per gear
  mutate(mature = longitud > Lmat) |> 
  group_by(tipo_arte, nombre_comun) |> 
  summarize(
    num_mature = sum(mature, na.rm = T),
    n = sum(!is.na(longitud)),
    perc_mature = (num_mature/n)*100
  ) |> 
  # Calculating a binary column if the percentage of maturity was higher than
  # 90% (the optimal condition)
  mutate(value = if_else(perc_mature>90, "Pos", "Neg")) |> 
  # mutate(tipo_arte = str_wrap(tipo_arte, width=10, whitespace_only = T)) |>
  # Plotting
  ggplot(aes(x=nombre_comun, y=perc_mature, fill=value, group=nombre_comun)) +  
  geom_hline(yintercept = 90, linetype='dashed', colour='black') +
  geom_point(shape = 23, size = 2, show.legend = F) +
  scale_fill_manual(values = c("firebrick", "forestgreen"))+ 
  facet_wrap('tipo_arte', ncol = 2) +
  qtheme(size=11) +
  labs(
    x = NULL, 
    y = "Porcentaje de capturas de individuos maduros")

```

## 3. Time-series trends (10-most caught species)
```{r t10-ts-dprep}
# Preparing a summarized database for time-series trend plotting (overall)
ts_df <- dat |> 
  filter(nombre_comun %in% top10_idx) |> 
  # Calculating average CPUE per date/trip (per species)
  group_by(fecha, nombre_comun) |> 
  summarize(
    len_avg = mean(longitud, na.rm=T),
    wt_avg = mean(peso, na.rm=T),
    eff_avg = mean(horas_pesca, na.rm=T),
    cpue_avg = mean(peso/horas_pesca, na.rm=T),
  ) |> 
  # Removing outliers
  mutate(isOutlierWt = ifelse(all(is.na(wt_avg)), 'No', iqr(wt_avg))) |> 
  mutate(isOutlierEff = ifelse(all(is.na(eff_avg)), 'No', iqr(eff_avg))) |> 
  filter(isOutlierEff == 'No', isOutlierWt == 'No') |>  
  ungroup()

# Helper function to quickly make a ts plot
make_ts <- function(df, var, grpvar, label){
  ts_df |> 
    ggplot(aes(x = fecha, y = !!sym(var))) +
    geom_smooth(method='lm', colour='firebrick', alpha=0.6) +
    geom_point(alpha = 0.8) +
    qtheme() +
    facet_wrap(grpvar, scales='free_y', nrow=5) +
    labs(
      x = NULL, 
      y=label
    )
}
```
### Captured length (split by species)
```{r t10-ts-length, fig.height=7}
make_ts(ts_df, 'len_avg', 'nombre_comun', 'Longitud [cm]')
```

### Captured weight (split by species)
```{r t10-ts-weight, fig.height=7}
make_ts(ts_df, 'wt_avg', 'nombre_comun', 'Peso [kg]')
```

### Fishing effort (split by species)
```{r t10-ts-effort, fig.height=7}
make_ts(ts_df, 'eff_avg', 'nombre_comun', 'Esfuerza [horas]')
```

### CPUE (split by species)
```{r t10-ts-cpue, fig.height=7}
make_ts(ts_df, 'cpue_avg', 'nombre_comun', 'Capturas por unidad de esfuerza [kg/hora]')
```

# Sexual maturity

Maturity data were only gathered for a small subset of the total sampling effort. The observations which contain maturity data have the following characteristics:
```{r matr-dat-summary}
maturity <- dat |> 
  filter(!is.na(madurez))

# How many obervations in total
print(paste("Total number of observations with maturity data:", nrow(maturity)))

# Which dates were the data gathered between?
print(paste('Date range:', range(maturity$fecha)))

# For which species?
print("Number of maturity observations by species:")
table(maturity$nombre_cientifico)

# What maturity classes are reported?
print("Distribution of maturity classes:")
table(maturity$madurez)

# What sexes are reported?
print("Distribution of sexes:")
table(maturity$sexo)
```
Since the only maturity class reported is "3" = "mature", and no sexes are reported at all, no further analysis could be conducted for these data.

<!-- ### 1. Seasonality of maturity status -->
<!-- ```{r matr-maturity-ssn} -->
<!-- # Since most of the data are for Calale, focusing only on that species -->
<!-- maturity |> -->
<!--   # filter(nombre_cientifico == 'Lutjanus synagris') |> -->
<!--   mutate(madurez = as.factor(madurez)) |> -->
<!--   ggplot(aes(x = month, fill=madurez)) + -->
<!--   geom_bar(stat='count', position='stack', colour='black') + -->
<!--   qtheme() + -->
<!--   labs(x=NULL, y='Numero de individuos', fill=str_wrap('Clase de Madurez', 10)) + -->
<!--   scale_x_discrete(drop=F) -->
<!-- ``` -->

<!-- ### 2. Seasonality of sex -->
<!-- # ```{r} -->
<!-- # # Since most of the data are for Calale, focusing only on that species -->
<!-- # maturity |> -->
<!-- #   # filter(nombre_cientifico == 'Lutjanus synagris') |> -->
<!-- #   mutate(sexo = as.factor(sexo)) |> -->
<!-- #   ggplot(aes(x = month, fill=sexo)) + -->
<!-- #   geom_bar(stat='count', position='stack', colour='black') + -->
<!-- #   qtheme() + -->
<!-- #   labs(x=NULL, y='Numero de individuos', fill='Sexo') + -->
<!-- #   scale_x_discrete(drop=F) -->
<!-- # ``` -->

